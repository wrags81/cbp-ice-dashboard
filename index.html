<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBP & ICE Contract Spending Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        .fy-selector {
            margin-top: 1rem;
        }
        .fy-selector select {
            font-size: 1.1rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: white;
            color: #1a365d;
            font-weight: 600;
            cursor: pointer;
        }
        .fy-selector select:hover {
            background: #edf2f7;
        }
        .export-btn {
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border: none;
            border-radius: 6px;
            background: #38a169;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .export-btn:hover {
            background: #2f855a;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card.cbp {
            border-left: 4px solid #3182ce;
        }
        .card.ice {
            border-left: 4px solid #e53e3e;
        }
        .card.total {
            border-left: 4px solid #38a169;
        }
        .card h3 {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        .card .amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a365d;
        }
        .card .count {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chart-card h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #1a365d;
        }
        .chart-container {
            position: relative;
            height: 350px;
        }
        .table-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        .table-section h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #1a365d;
        }
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .tab {
            padding: 0.5rem 1rem;
            border: none;
            background: #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .tab:hover {
            background: #cbd5e0;
        }
        .tab.active {
            background: #3182ce;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f7fafc;
            font-weight: 600;
            font-size: 0.85rem;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 1.5rem;
        }
        th.sortable:hover {
            background: #edf2f7;
            color: #2d3748;
        }
        th.sortable::after {
            content: '⇅';
            position: absolute;
            right: 0.5rem;
            opacity: 0.3;
            font-size: 0.75rem;
        }
        th.sortable.asc::after {
            content: '↑';
            opacity: 1;
            color: #3182ce;
        }
        th.sortable.desc::after {
            content: '↓';
            opacity: 1;
            color: #3182ce;
        }
        td {
            font-size: 0.9rem;
            vertical-align: top;
        }
        tr:hover {
            background: #f7fafc;
        }
        .amount-cell {
            font-family: 'SF Mono', Monaco, monospace;
            text-align: right;
            white-space: nowrap;
        }
        .positive {
            color: #38a169;
        }
        .negative {
            color: #e53e3e;
        }
        .agency-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .agency-badge.cbp {
            background: #ebf8ff;
            color: #2b6cb0;
        }
        .agency-badge.ice {
            background: #fff5f5;
            color: #c53030;
        }
        .recipient-link {
            color: #3182ce;
            text-decoration: none;
        }
        .recipient-link:hover {
            text-decoration: underline;
            color: #2c5282;
        }
        .psc-cell, .naics-cell {
            font-size: 0.8rem;
            color: #666;
            max-width: 200px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
        }
        .description-cell {
            font-size: 0.85rem;
            max-width: 300px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
        }
        .footer {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 0.85rem;
        }
        .footer a {
            color: #3182ce;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        .search-box {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            width: 300px;
            font-size: 0.9rem;
        }
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
        }
        .loading-overlay.hidden {
            display: none;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 1rem;
            color: #4a5568;
            font-size: 1.1rem;
        }
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Loading <span id="loadingFY">FY26</span> data...</div>
    </div>

    <div class="header">
        <h1>CBP & ICE Contract Spending Dashboard</h1>
        <p>Federal Action Obligations | Data Source: USAspending.gov</p>
        <div class="fy-selector">
            <select id="fySelect" onchange="changeFiscalYear()">
                <option value="trump2">Since Jan 20, 2025 (Trump Admin)</option>
                <option value="2026">FY 2026 (Oct 2025 - Sep 2026)</option>
                <option value="2025">FY 2025 (Oct 2024 - Sep 2025)</option>
                <option value="2024">FY 2024 (Oct 2023 - Sep 2024)</option>
                <option value="2023">FY 2023 (Oct 2022 - Sep 2023)</option>
                <option value="2022">FY 2022 (Oct 2021 - Sep 2022)</option>
                <option value="2021">FY 2021 (Oct 2020 - Sep 2021)</option>
            </select>
            <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
        </div>
    </div>

    <div class="container">
        <div class="summary-cards">
            <div class="card cbp">
                <h3>CBP Total Obligations</h3>
                <div class="amount" id="cbpTotal">Loading...</div>
                <div class="count" id="cbpCount"></div>
            </div>
            <div class="card ice">
                <h3>ICE Total Obligations</h3>
                <div class="amount" id="iceTotal">Loading...</div>
                <div class="count" id="iceCount"></div>
            </div>
            <div class="card total">
                <h3>Combined Total</h3>
                <div class="amount" id="combinedTotal">Loading...</div>
                <div class="count" id="combinedCount"></div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Monthly Obligations Trend</h3>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Agency Comparison</h3>
                <div class="chart-container">
                    <canvas id="agencyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Top 10 CBP Recipients</h3>
                <div class="chart-container">
                    <canvas id="cbpRecipientsChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Top 10 ICE Recipients</h3>
                <div class="chart-container">
                    <canvas id="iceRecipientsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Top 10 Product/Service Categories (PSC)</h3>
                <div class="chart-container">
                    <canvas id="pscChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Top 10 Industries (NAICS)</h3>
                <div class="chart-container">
                    <canvas id="naicsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-controls">
                <div class="tabs">
                    <button class="tab active" onclick="showTable('all')">All Transactions</button>
                    <button class="tab" onclick="showTable('cbp')">CBP Only</button>
                    <button class="tab" onclick="showTable('ice')">ICE Only</button>
                </div>
                <input type="text" class="search-box" id="searchBox" placeholder="Search recipient, description..." oninput="filterTable()">
            </div>
            <div style="overflow-x: auto;">
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="agency" onclick="sortTable('agency')">Agency</th>
                            <th class="sortable" data-sort="recipient" onclick="sortTable('recipient')">Recipient</th>
                            <th class="sortable" data-sort="amount" onclick="sortTable('amount')" style="text-align: right;">Amount</th>
                            <th class="sortable" data-sort="date" onclick="sortTable('date')">Date</th>
                            <th class="sortable" data-sort="psc" onclick="sortTable('psc')">PSC</th>
                            <th class="sortable" data-sort="naics" onclick="sortTable('naics')">NAICS</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="7" class="loading">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 1rem; text-align: center;">
                <button class="tab" id="loadMoreBtn" onclick="loadMore()" style="display: none;">Load More</button>
                <span id="showingCount" style="color: #666; font-size: 0.85rem;"></span>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Data sourced from <a href="https://usaspending.gov" target="_blank">USAspending.gov</a> API</p>
        <p id="fyDateRange">FY26: October 1, 2025 - September 30, 2026</p>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentFilter = 'all';
        let displayedRows = 50;
        let currentFY = 'trump2';
        let currentSort = { column: null, direction: 'asc' };

        // Chart instances for cleanup
        let monthlyChartInstance = null;
        let agencyChartInstance = null;
        let cbpRecipientsChartInstance = null;
        let iceRecipientsChartInstance = null;
        let pscChartInstance = null;
        let naicsChartInstance = null;

        // Fiscal year date ranges
        const fyDates = {
            'trump2': { start: '2025-01-20', end: '2026-09-30', label: 'Since January 20, 2025 (Trump Administration)', isSpecial: true },
            '2026': { start: '2025-10-01', end: '2026-09-30', label: 'FY26: October 1, 2025 - September 30, 2026' },
            '2025': { start: '2024-10-01', end: '2025-09-30', label: 'FY25: October 1, 2024 - September 30, 2025' },
            '2024': { start: '2023-10-01', end: '2024-09-30', label: 'FY24: October 1, 2023 - September 30, 2024' },
            '2023': { start: '2022-10-01', end: '2023-09-30', label: 'FY23: October 1, 2022 - September 30, 2023' },
            '2022': { start: '2021-10-01', end: '2022-09-30', label: 'FY22: October 1, 2021 - September 30, 2022' },
            '2021': { start: '2020-10-01', end: '2021-09-30', label: 'FY21: October 1, 2020 - September 30, 2021' }
        };

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function changeFiscalYear() {
            const select = document.getElementById('fySelect');
            currentFY = select.value;
            const fyConfig = fyDates[currentFY];
            document.getElementById('loadingFY').textContent = fyConfig.isSpecial ? 'Trump Admin' : 'FY' + currentFY.slice(-2);
            document.getElementById('fyDateRange').textContent = fyConfig.label;
            loadData();
        }

        // Format currency
        function formatCurrency(num) {
            if (num === null || num === undefined) return '$0.00';
            const absNum = Math.abs(num);
            if (absNum >= 1e9) {
                return (num < 0 ? '-' : '') + '$' + (absNum / 1e9).toFixed(2) + 'B';
            } else if (absNum >= 1e6) {
                return (num < 0 ? '-' : '') + '$' + (absNum / 1e6).toFixed(2) + 'M';
            } else if (absNum >= 1e3) {
                return (num < 0 ? '-' : '') + '$' + (absNum / 1e3).toFixed(1) + 'K';
            }
            return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatFullCurrency(num) {
            if (num === null || num === undefined) return '$0.00';
            return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Load data - try CSV first, fall back to API
        async function loadData() {
            showLoading(true);

            const fyConfig = fyDates[currentFY];

            // Special handling for "Since Jan 20, 2025" - need to load FY25 and FY26 and filter
            if (fyConfig.isSpecial) {
                await loadSpecialDateRange(fyConfig.start);
                return;
            }

            // Try to load from CSV file first
            const csvFile = `data/CBP_ICE_FY${currentFY}_Contract_Obligations.csv`;

            try {
                const response = await fetch(csvFile);
                if (response.ok) {
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: true,
                        complete: function(results) {
                            allData = results.data.filter(row => row.Agency && row['Federal Action Obligation']);
                            processData();
                            showLoading(false);
                        }
                    });
                    return;
                }
            } catch (error) {
                console.log('CSV not found, fetching from API...');
            }

            // Fall back to API
            await fetchFromAPI();
        }

        // Load data from multiple fiscal years and filter by date
        async function loadSpecialDateRange(startDate) {
            allData = [];
            const filesToLoad = ['2025', '2026'];

            for (const fy of filesToLoad) {
                const csvFile = `data/CBP_ICE_FY${fy}_Contract_Obligations.csv`;
                try {
                    const response = await fetch(csvFile);
                    if (response.ok) {
                        const csvText = await response.text();
                        const parsed = Papa.parse(csvText, { header: true });
                        const filtered = parsed.data.filter(row => {
                            if (!row.Agency || !row['Federal Action Obligation']) return false;
                            const actionDate = row['Action Date'] || '';
                            return actionDate >= startDate;
                        });
                        allData = allData.concat(filtered);
                    }
                } catch (error) {
                    console.log(`Could not load FY${fy} data`);
                }
            }

            processData();
            showLoading(false);
        }

        async function fetchFromAPI() {
            const fy = fyDates[currentFY];
            allData = [];

            for (const agency of ['U.S. Customs and Border Protection', 'U.S. Immigration and Customs Enforcement']) {
                const abbrev = agency.includes('Customs and Border') ? 'CBP' : 'ICE';
                let page = 1;

                while (true) {
                    try {
                        const response = await fetch('https://api.usaspending.gov/api/v2/search/spending_by_transaction/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                filters: {
                                    agencies: [{ type: 'awarding', tier: 'subtier', name: agency }],
                                    time_period: [{ start_date: fy.start, end_date: fy.end }],
                                    award_type_codes: ['A', 'B', 'C', 'D']
                                },
                                fields: ['Award ID', 'Recipient Name', 'Transaction Amount', 'Action Date',
                                        'Transaction Description', 'product_or_service_description'],
                                page: page,
                                limit: 100,
                                sort: 'Transaction Amount',
                                order: 'desc'
                            })
                        });

                        const data = await response.json();
                        const results = data.results || [];

                        results.forEach(r => {
                            allData.push({
                                Agency: abbrev,
                                'Award ID': r['Award ID'],
                                'Recipient Name': r['Recipient Name'],
                                'Federal Action Obligation': r['Transaction Amount'],
                                'Action Date': r['Action Date'],
                                'Transaction Description': r['Transaction Description'],
                                'Product/Service Description': r['product_or_service_description']
                            });
                        });

                        if (!data.page_metadata?.hasNext || results.length === 0) break;
                        page++;
                    } catch (error) {
                        console.error('API error:', error);
                        break;
                    }
                }
            }

            processData();
            showLoading(false);
        }

        function destroyCharts() {
            if (monthlyChartInstance) { monthlyChartInstance.destroy(); monthlyChartInstance = null; }
            if (agencyChartInstance) { agencyChartInstance.destroy(); agencyChartInstance = null; }
            if (cbpRecipientsChartInstance) { cbpRecipientsChartInstance.destroy(); cbpRecipientsChartInstance = null; }
            if (iceRecipientsChartInstance) { iceRecipientsChartInstance.destroy(); iceRecipientsChartInstance = null; }
            if (pscChartInstance) { pscChartInstance.destroy(); pscChartInstance = null; }
            if (naicsChartInstance) { naicsChartInstance.destroy(); naicsChartInstance = null; }
        }

        function processData() {
            destroyCharts();

            // Calculate totals
            let cbpTotal = 0, iceTotal = 0, cbpCount = 0, iceCount = 0;
            const cbpByRecipient = {}, iceByRecipient = {};
            const monthlyData = {};
            const pscData = {};
            const naicsData = {};

            allData.forEach(row => {
                const amount = parseFloat(row['Federal Action Obligation']) || 0;
                const agency = row.Agency;
                const recipient = row['Recipient Name'] || 'Unknown';
                const date = row['Action Date'] || '';
                const month = date.substring(0, 7);
                const psc = row['Product/Service Description'] || 'Unspecified';
                const naics = row['NAICS Description'] || 'Unspecified';

                if (agency === 'CBP') {
                    cbpTotal += amount;
                    cbpCount++;
                    cbpByRecipient[recipient] = (cbpByRecipient[recipient] || 0) + amount;
                } else if (agency === 'ICE') {
                    iceTotal += amount;
                    iceCount++;
                    iceByRecipient[recipient] = (iceByRecipient[recipient] || 0) + amount;
                }

                if (month) {
                    if (!monthlyData[month]) {
                        monthlyData[month] = { cbp: 0, ice: 0 };
                    }
                    if (agency === 'CBP') {
                        monthlyData[month].cbp += amount;
                    } else if (agency === 'ICE') {
                        monthlyData[month].ice += amount;
                    }
                }

                // Aggregate PSC and NAICS
                if (psc && psc !== 'Unspecified') {
                    pscData[psc] = (pscData[psc] || 0) + amount;
                }
                if (naics && naics !== 'Unspecified') {
                    naicsData[naics] = (naicsData[naics] || 0) + amount;
                }
            });

            // Update summary cards
            document.getElementById('cbpTotal').textContent = formatCurrency(cbpTotal);
            document.getElementById('cbpCount').textContent = `${cbpCount.toLocaleString()} transactions`;
            document.getElementById('iceTotal').textContent = formatCurrency(iceTotal);
            document.getElementById('iceCount').textContent = `${iceCount.toLocaleString()} transactions`;
            document.getElementById('combinedTotal').textContent = formatCurrency(cbpTotal + iceTotal);
            document.getElementById('combinedCount').textContent = `${(cbpCount + iceCount).toLocaleString()} transactions`;

            // Create charts
            createMonthlyChart(monthlyData);
            createAgencyChart(cbpTotal, iceTotal);
            createRecipientChart('cbpRecipientsChart', cbpByRecipient, '#3182ce', 'cbp');
            createRecipientChart('iceRecipientsChart', iceByRecipient, '#e53e3e', 'ice');
            createCategoryChart('pscChart', pscData, '#805ad5', 'psc');
            createCategoryChart('naicsChart', naicsData, '#dd6b20', 'naics');

            // Populate table
            filteredData = [...allData];
            currentFilter = 'all';
            document.querySelectorAll('.tabs .tab').forEach((t, i) => t.classList.toggle('active', i === 0));
            document.getElementById('searchBox').value = '';
            displayedRows = 50;
            renderTable();
        }

        function createMonthlyChart(monthlyData) {
            const months = Object.keys(monthlyData).sort();
            const ctx = document.getElementById('monthlyChart').getContext('2d');

            monthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'CBP',
                            data: months.map(m => monthlyData[m].cbp),
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49, 130, 206, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ICE',
                            data: months.map(m => monthlyData[m].ice),
                            borderColor: '#e53e3e',
                            backgroundColor: 'rgba(229, 62, 62, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAgencyChart(cbpTotal, iceTotal) {
            const ctx = document.getElementById('agencyChart').getContext('2d');

            agencyChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['CBP', 'ICE'],
                    datasets: [{
                        data: [cbpTotal, iceTotal],
                        backgroundColor: ['#3182ce', '#e53e3e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = cbpTotal + iceTotal;
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(context.raw) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createRecipientChart(canvasId, recipientData, color, type) {
            const sorted = Object.entries(recipientData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById(canvasId).getContext('2d');

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(r => r[0].length > 25 ? r[0].substring(0, 25) + '...' : r[0]),
                    datasets: [{
                        data: sorted.map(r => r[1]),
                        backgroundColor: color,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return sorted[context[0].dataIndex][0];
                                },
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            if (type === 'cbp') {
                cbpRecipientsChartInstance = chart;
            } else {
                iceRecipientsChartInstance = chart;
            }
        }

        function createCategoryChart(canvasId, categoryData, color, type) {
            const sorted = Object.entries(categoryData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById(canvasId).getContext('2d');

            // Helper to wrap long labels
            function wrapLabel(str, maxWidth) {
                if (str.length <= maxWidth) return [str];
                const words = str.split(/[\s-]+/);
                const lines = [];
                let currentLine = '';

                words.forEach(word => {
                    if ((currentLine + ' ' + word).trim().length <= maxWidth) {
                        currentLine = (currentLine + ' ' + word).trim();
                    } else {
                        if (currentLine) lines.push(currentLine);
                        currentLine = word.length > maxWidth ? word.substring(0, maxWidth - 3) + '...' : word;
                    }
                });
                if (currentLine) lines.push(currentLine);
                return lines.slice(0, 3); // Max 3 lines
            }

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(r => wrapLabel(r[0], 40)),
                    datasets: [{
                        data: sorted.map(r => r[1]),
                        backgroundColor: color,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return sorted[context[0].dataIndex][0];
                                },
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                font: { size: 11 },
                                autoSkip: false
                            }
                        },
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            if (type === 'psc') {
                pscChartInstance = chart;
            } else {
                naicsChartInstance = chart;
            }
        }

        function showTable(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            filterTable();
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            filteredData = allData.filter(row => {
                const matchesAgency = currentFilter === 'all' ||
                    row.Agency.toLowerCase() === currentFilter;
                const matchesSearch = !searchTerm ||
                    (row['Recipient Name'] || '').toLowerCase().includes(searchTerm) ||
                    (row['Transaction Description'] || '').toLowerCase().includes(searchTerm) ||
                    (row['Product/Service Description'] || '').toLowerCase().includes(searchTerm);
                return matchesAgency && matchesSearch;
            });

            // Apply current sort if any
            if (currentSort.column) {
                applySorting();
            }

            displayedRows = 50;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const toShow = filteredData.slice(0, displayedRows);

            if (toShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No transactions found</td></tr>';
                document.getElementById('showingCount').textContent = '';
                document.getElementById('loadMoreBtn').style.display = 'none';
                return;
            }

            tbody.innerHTML = toShow.map(row => {
                const amount = parseFloat(row['Federal Action Obligation']) || 0;
                const amountClass = amount >= 0 ? 'positive' : 'negative';
                const agencyClass = row.Agency.toLowerCase();
                const description = row['Transaction Description'] || row['Product/Service Description'] || '';
                const psc = row['Product/Service Description'] || '';
                const naics = row['NAICS Description'] || '';
                const awardId = row['Award ID'] || '';

                // Build USAspending link
                const usaSpendingLink = awardId ? `https://www.usaspending.gov/award/${encodeURIComponent(awardId)}` : '';

                return `<tr>
                    <td><span class="agency-badge ${agencyClass}">${row.Agency}</span></td>
                    <td>${usaSpendingLink ? `<a href="${usaSpendingLink}" target="_blank" class="recipient-link">${row['Recipient Name'] || 'Unknown'}</a>` : (row['Recipient Name'] || 'Unknown')}</td>
                    <td class="amount-cell ${amountClass}">${formatFullCurrency(amount)}</td>
                    <td style="white-space: nowrap;">${row['Action Date'] || ''}</td>
                    <td class="psc-cell">${psc}</td>
                    <td class="naics-cell">${naics}</td>
                    <td class="description-cell">${description}</td>
                </tr>`;
            }).join('');

            document.getElementById('showingCount').textContent =
                `Showing ${Math.min(displayedRows, filteredData.length)} of ${filteredData.length} transactions`;

            document.getElementById('loadMoreBtn').style.display =
                displayedRows < filteredData.length ? 'inline-block' : 'none';
        }

        function loadMore() {
            displayedRows += 50;
            renderTable();
        }

        // Sort table by column
        function sortTable(column) {
            // Toggle direction if same column, otherwise start with ascending
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update header styles
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === column) {
                    th.classList.add(currentSort.direction);
                }
            });

            applySorting();
            displayedRows = 50;
            renderTable();
        }

        function applySorting() {
            const col = currentSort.column;
            const dir = currentSort.direction === 'asc' ? 1 : -1;

            filteredData.sort((a, b) => {
                let valA, valB;

                switch (col) {
                    case 'agency':
                        valA = (a.Agency || '').toLowerCase();
                        valB = (b.Agency || '').toLowerCase();
                        break;
                    case 'recipient':
                        valA = (a['Recipient Name'] || '').toLowerCase();
                        valB = (b['Recipient Name'] || '').toLowerCase();
                        break;
                    case 'amount':
                        valA = parseFloat(a['Federal Action Obligation']) || 0;
                        valB = parseFloat(b['Federal Action Obligation']) || 0;
                        break;
                    case 'date':
                        valA = a['Action Date'] || '';
                        valB = b['Action Date'] || '';
                        break;
                    case 'psc':
                        valA = (a['Product/Service Description'] || '').toLowerCase();
                        valB = (b['Product/Service Description'] || '').toLowerCase();
                        break;
                    case 'naics':
                        valA = (a['NAICS Description'] || '').toLowerCase();
                        valB = (b['NAICS Description'] || '').toLowerCase();
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });
        }

        // Export current data to CSV
        function exportToCSV() {
            if (allData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Agency', 'Award ID', 'Recipient Name', 'Federal Action Obligation', 'Action Date', 'PSC Description', 'NAICS Description', 'Transaction Description', 'USAspending Link'];
            const rows = allData.map(row => {
                const awardId = row['Award ID'] || '';
                const link = awardId ? `https://www.usaspending.gov/award/${encodeURIComponent(awardId)}` : '';
                return [
                    row.Agency || '',
                    awardId,
                    `"${(row['Recipient Name'] || '').replace(/"/g, '""')}"`,
                    row['Federal Action Obligation'] || 0,
                    row['Action Date'] || '',
                    `"${(row['Product/Service Description'] || '').replace(/"/g, '""')}"`,
                    `"${(row['NAICS Description'] || '').replace(/"/g, '""')}"`,
                    `"${(row['Transaction Description'] || '').replace(/"/g, '""')}"`,
                    link
                ];
            });

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const fyConfig = fyDates[currentFY];
            const filename = fyConfig.isSpecial
                ? 'CBP_ICE_Since_Jan20_2025.csv'
                : `CBP_ICE_FY${currentFY}_Contract_Obligations.csv`;

            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();

            URL.revokeObjectURL(url);
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
